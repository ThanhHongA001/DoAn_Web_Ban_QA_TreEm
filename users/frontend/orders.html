<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Theo dõi đơn hàng cá nhân - SuSu Kids Shop.">
    <meta name="keywords" content="đơn hàng, lịch sử mua hàng, quần áo trẻ em">
    <title>Theo dõi đơn hàng - SuSu Kids Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body class="bg-yellow-50 font-sans">
    <!-- Header -->
    <header class="bg-white shadow-md fixed w-full top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <img id="site-logo" src="" alt="Logo SuSu Kids" class="h-16 rounded-full">
                <h1 class="ml-4 text-3xl font-bold text-blue-600">SuSu Kids Shop</h1>
            </div>
            <div class="flex items-center space-x-6">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Tìm quần áo cho bé..." class="p-2 pr-10 border border-blue-300 rounded-full w-72 focus:outline-none focus:ring-2 focus:ring-blue-400" oninput="fetchSearchSuggestions()" onkeypress="if(event.key === 'Enter') searchProducts()">
                    <button onclick="searchProducts()" class="absolute right-2 top-2 text-blue-600 hover:text-blue-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                    <div id="search-suggestions" class="absolute hidden bg-white border border-blue-300 rounded-lg w-full mt-1 shadow-lg z-10"></div>
                </div>
                <nav class="flex space-x-6">
                    <a href="index.html" class="text-blue-600 hover:text-pink-600 font-semibold">Trang chủ</a>
                    <a href="about.html" class="text-blue-600 hover:text-pink-600 font-semibold">Giới thiệu</a>
                    <a href="category.html" class="text-blue-600 hover:text-pink-600 font-semibold">Sản phẩm</a>
                    <a href="blog.html" class="text-blue-600 hover:text-pink-600 font-semibold">Blog</a>
                    <a href="contact.html" class="text-blue-600 hover:text-pink-600 font-semibold">Liên hệ</a>
                    <a href="cart.html" class="relative">
                        <svg class="w-6 h-6 text-blue-600 hover:text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-pink-500 text-white text-xs rounded-full px-1">0</span>
                    </a>
                    <div class="relative">
                        <button id="user-menu-btn" class="text-blue-600 hover:text-pink-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                        </button>
                        <div id="user-menu" class="absolute hidden right-0 mt-2 w-48 bg-white border border-blue-300 rounded-lg shadow-lg">
                            <div id="guest-menu" class="py-2">
                                <a href="login.html" class="block px-4 py-2 text-blue-600 hover:bg-blue-50">Đăng nhập</a>
                                <a href="register.html" class="block px-4 py-2 text-blue-600 hover:bg-blue-50">Đăng ký</a>
                            </div>
                            <div id="user-settings-menu" class="hidden py-2">
                                <a href="account.html" class="block px-4 py-2 text-blue-600 hover:bg-blue-50">Thông tin cá nhân</a>
                                <a href="orders.html" class="block px-4 py-2 text-blue-600 hover:bg-blue-50">Đơn hàng</a>
                                <a href="change-password.html" class="block px-4 py-2 text-blue-600 hover:bg-blue-50">Đổi mật khẩu</a>
                                <a href="#" id="logout-btn" class="block px-4 py-2 text-blue-600 hover:bg-blue-50">Đăng xuất</a>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Breadcrumb -->
    <div class="container mx-auto px-4 py-4 mt-24">
        <nav class="text-gray-600 text-sm">
            <a href="index.html" class="hover:text-blue-600">Trang chủ</a> / 
            <span class="text-blue-600">Theo dõi đơn hàng</span>
        </nav>
    </div>

    <!-- Orders Section -->
    <section class="container mx-auto px-4 py-8">
        <h2 class="text-3xl font-bold text-center text-blue-600 mb-8">Theo dõi đơn hàng của bạn</h2>
        <div id="login-prompt" class="hidden bg-white p-6 rounded-lg shadow-md text-center">
            <p class="text-gray-600 mb-4">Vui lòng đăng nhập để xem danh sách đơn hàng.</p>
            <a href="login.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">Đăng nhập</a>
        </div>
        <div id="orders-container" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <table class="w-full text-left table-auto">
                    <thead>
                        <tr class="border-b">
                            <th class="py-3 px-4 text-blue-600">Mã đơn hàng</th>
                            <th class="py-3 px-4 text-blue-600">Ngày đặt</th>
                            <th class="py-3 px-4 text-blue-600">Tổng tiền</th>
                            <th class="py-3 px-4 text-blue-600">Trạng thái</th>
                            <th class="py-3 px-4 text-blue-600">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table"></tbody>
                </table>
                <p id="no-orders" class="hidden text-center text-gray-600 mt-4">Bạn chưa có đơn hàng nào.</p>
            </div>
        </div>
    </section>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-20">
        <div class="bg-white p-8 rounded-lg max-w-3xl w-full max-h-[80vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-blue-600 mb-4">Chi tiết đơn hàng</h2>
            <div id="order-details-content"></div>
            <div id="modal-actions" class="mt-6 flex justify-end space-x-4"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-blue-600 text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">SuSu Kids</h3>
                    <p>Thời trang trẻ em chất lượng, an toàn cho bé yêu.</p>
                    <ul>
                        <li><a href="about.html" class="text-yellow-400 hover:text-yellow-300">Giới thiệu</a></li>
                        <li><a href="baomat.html" class="text-yellow-400 hover:text-yellow-300">Chính sách bảo mật</a></li>
                        <li><a href="doitra.html" class="text-yellow-400 hover:text-yellow-300">Chính sách đổi trả</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Liên kết nhanh</h3>
                    <ul>
                        <li><a href="category.html" class="hover:text-yellow-400">Sản phẩm</a></li>
                        <li><a href="blog.html" class="hover:text-yellow-400">Blog</a></li>
                        <li><a href="contact.html" class="hover:text-yellow-400">Liên hệ</a></li>
                        <li><a href="size.html" class="hover:text-yellow-400">Hướng dẫn chọn size</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Liên hệ</h3>
                    <p>Email: support@susukids.com</p>
                    <p>Phone: 0905 123 456</p>
                    <p>Address: 456 Đường Trẻ Thơ, Hà Nội</p>
                </div>
            </div>
            <div class="mt-8 text-center">
                <p>© 2025 SuSu Kids Shop. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="assets/js/user-menu.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
            fetchCartCount();
        });

        function checkLoginStatus() {
            fetch('api/check_session.php')
                .then(response => response.json())
                .then(data => {
                    if (data.isLoggedIn) {
                        document.getElementById('orders-container').classList.remove('hidden');
                        document.getElementById('login-prompt').classList.add('hidden');
                        fetchOrders();
                    } else {
                        document.getElementById('orders-container').classList.add('hidden');
                        document.getElementById('login-prompt').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error checking login status:', error);
                    document.getElementById('login-prompt').classList.remove('hidden');
                });
        }

        function fetchCartCount() {
            fetch('api/cart.php?action=count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('cart-count').textContent = data.count || 0;
                })
                .catch(error => console.error('Error fetching cart count:', error));
        }

        function fetchSearchSuggestions() {
            const query = document.getElementById('search-input').value.trim();
            const suggestionsDiv = document.getElementById('search-suggestions');
            if (query.length < 2) {
                suggestionsDiv.classList.add('hidden');
                suggestionsDiv.innerHTML = '';
                return;
            }
            fetch(`api/search_products.php?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsDiv.innerHTML = '';
                    if (data.length > 0) {
                        suggestionsDiv.classList.remove('hidden');
                        data.forEach(product => {
                            const div = document.createElement('div');
                            div.className = 'flex items-center px-4 py-2 text-blue-600 cursor-pointer hover:bg-blue-50';
                            div.innerHTML = `
                                <img src="${product.image}" alt="${product.name}" class="w-10 h-10 rounded mr-2 object-cover">
                                <div>
                                    <p>${product.name}</p>
                                    <p class="text-pink-600">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.discounted_price)}</p>
                                </div>
                            `;
                            div.onclick = () => window.location.href = `product-details.html?code=${product.code}`;
                            suggestionsDiv.appendChild(div);
                        });
                    } else {
                        suggestionsDiv.classList.add('hidden');
                    }
                })
                .catch(error => console.error('Error fetching suggestions:', error));
        }

        function searchProducts() {
            const query = document.getElementById('search-input').value.trim();
            window.location.href = `category.html?q=${encodeURIComponent(query)}`;
        }

        function fetchOrders() {
            fetch('api/orders.php?action=list')
                .then(response => response.json())
                .then(data => {
                    const ordersTable = document.getElementById('orders-table');
                    const noOrders = document.getElementById('no-orders');
                    ordersTable.innerHTML = '';

                    if (data.status === 'error') {
                        noOrders.textContent = data.error || 'Lỗi khi tải danh sách đơn hàng';
                        noOrders.classList.remove('hidden');
                        return;
                    }

                    if (data.orders.length === 0) {
                        noOrders.classList.remove('hidden');
                        return;
                    }

                    noOrders.classList.add('hidden');
                    data.orders.forEach(order => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b hover:bg-gray-100';
                        const statusText = {
                            'pending': 'Chờ xử lý',
                            'confirmed': 'Đã xác nhận',
                            'in transit': 'Đang vận chuyển',
                            'shipped': 'Đã giao',
                            'completed': 'Hoàn thành',
                            'cancelled': 'Đã hủy'
                        }[order.status] || order.status;
                        const canCancel = ['pending', 'confirmed', 'in transit'].includes(order.status);
                        tr.innerHTML = `
                            <td class="py-3 px-4">${order.order_id}</td>
                            <td class="py-3 px-4">${new Date(order.created_at).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' })}</td>
                            <td class="py-3 px-4">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(order.total)}</td>
                            <td class="py-3 px-4">${statusText}</td>
                            <td class="py-3 px-4 flex space-x-2">
                                <button onclick="viewOrderDetails(${order.order_id})" class="text-blue-600 hover:text-blue-800 underline">Xem chi tiết</button>
                                ${canCancel ? `<button onclick="cancelOrder(${order.order_id})" class="text-red-600 hover:text-red-800 underline">Hủy đơn hàng</button>` : ''}
                            </td>
                        `;
                        ordersTable.appendChild(tr);
                    });
                })
                .catch(error => {
                    console.error('Error fetching orders:', error);
                    document.getElementById('no-orders').textContent = 'Lỗi khi tải danh sách đơn hàng';
                    document.getElementById('no-orders').classList.remove('hidden');
                });
        }

        function viewOrderDetails(orderId) {
            fetch(`api/orders.php?action=details&order_id=${orderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        alert(data.error || 'Lỗi khi tải chi tiết đơn hàng');
                        return;
                    }

                    const statusText = {
                        'pending': 'Chờ xử lý',
                        'confirmed': 'Đã xác nhận',
                        'in transit': 'Đang vận chuyển',
                        'shipped': 'Đã giao',
                        'completed': 'Hoàn thành',
                        'cancelled': 'Đã hủy'
                    }[data.status] || data.status;

                    const paymentMethodText = {
                        'cod': 'Thanh toán khi nhận hàng',
                        'bank_transfer': 'Chuyển khoản ngân hàng',
                        'credit_card': 'Thẻ tín dụng'
                    }[data.payment_method] || data.payment_method;

                    const canCancel = ['pending', 'confirmed', 'in transit'].includes(data.status);
                    const modalContent = document.getElementById('order-details-content');
                    modalContent.innerHTML = `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-blue-600 mb-2">Thông tin đơn hàng</h3>
                            <p><strong>Mã đơn hàng:</strong> ${data.order_id}</p>
                            <p><strong>Ngày đặt:</strong> ${new Date(data.created_at).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                            <p><strong>Tổng tiền:</strong> ${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.total)}</p>
                            <p><strong>Trạng thái:</strong> ${statusText}</p>
                            <p><strong>Người nhận:</strong> ${data.shipping_address}</p>
                            <p><strong>Phương thức thanh toán:</strong> ${paymentMethodText}</p>
                            <p><strong>Mã giảm giá:</strong> ${data.voucher_code || 'Không có'}</p>
                            <p><strong>Ghi chú:</strong> ${data.note || 'Không có'}</p>
                        </div>
                        <h3 class="text-lg font-semibold text-blue-600 mb-2">Sản phẩm</h3>
                        <div class="space-y-4">
                            ${data.items.map(item => `
                                <div class="flex items-center space-x-4 border-b pb-2">
                                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-contain rounded">
                                    <div class="flex-1">
                                        <p class="text-blue-600 font-semibold">${item.name}</p>
                                        <p class="text-gray-600">Kích cỡ: ${item.size}, Màu sắc: ${item.color}</p>
                                        <p class="text-gray-600">Số lượng: ${item.quantity}</p>
                                        <p class="text-pink-600 font-bold">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.price)}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    const modalActions = document.getElementById('modal-actions');
                    modalActions.innerHTML = `
                        ${canCancel ? `<button onclick="cancelOrder(${data.order_id})" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">Hủy đơn hàng</button>` : ''}
                        ${['pending'].includes(data.status) && data.payment_method ? `<button onclick="processPayment(${data.order_id}, '${data.payment_method}', ${data.total})" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">Thanh toán</button>` : ''}
                        <button onclick="closeModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">Đóng</button>
                    `;
                    document.getElementById('order-details-modal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error fetching order details:', error);
                    alert('Lỗi khi tải chi tiết đơn hàng');
                });
        }

        function processPayment(orderId, paymentMethod, total) {
            try {
                // Ensure total is a valid number
                const formattedTotal = Number(total).toFixed(2);
                if (isNaN(formattedTotal)) {
                    throw new Error('Số tiền không hợp lệ');
                }
                if (paymentMethod === 'bank_transfer') {
                    window.location.href = `bank-transfer.html?order_id=${orderId}&total=${encodeURIComponent(formattedTotal)}`;
                } else if (paymentMethod === 'credit_card') {
                    window.location.href = `credit-card.html?order_id=${orderId}&total=${encodeURIComponent(formattedTotal)}`;
                } else if (paymentMethod === 'cod') {
                    alert('Thanh toán khi nhận hàng (COD) đã được áp dụng. Đơn hàng sẽ được xử lý.');
                } else {
                    alert('Phương thức thanh toán không hỗ trợ.');
                }
            } catch (error) {
                console.error('Error in processPayment:', error);
                alert('Thông tin thanh toán không hợp lệ. Vui lòng kiểm tra lại.');
            }
        }

        function cancelOrder(orderId) {
            if (!confirm('Bạn có chắc muốn hủy đơn hàng này?')) return;
            fetch(`api/orders.php?action=cancel&order_id=${orderId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Đơn hàng đã được hủy thành công');
                        fetchOrders(); // Refresh the orders list
                        closeModal();
                    } else {
                        alert(data.error || 'Lỗi khi hủy đơn hàng');
                    }
                })
                .catch(error => {
                    console.error('Error cancelling order:', error);
                    alert('Lỗi khi hủy đơn hàng');
                });
        }

        function closeModal() {
            document.getElementById('order-details-modal').classList.add('hidden');
        }

        //logo
        fetch("api/get_logo.php")
        .then(res => res.json())
        .then(data => {
            document.getElementById("site-logo").src = data.logo;
        })
        .catch(err => console.error(err));
    </script>
</body>
</html>